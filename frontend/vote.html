<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Votar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-5">
    <div class="card p-4 shadow">
        <h3 class="mb-4">Seleccionar candidato</h3>

        <ul id="candidates" class="list-group"></ul>

        <button type="button" class="btn btn-success mt-3" onclick="submitVote()">
            Confirmar voto
        </button>
    </div>
</div>

<script>

const params = new URLSearchParams(window.location.search);
const electionId = params.get("election_id");

let selectedCandidate = null;

// ðŸ”¹ Cargar candidatos (usando sesiÃ³n por cookie)
fetch(`http://localhost:5000/candidates/${electionId}`, {
    credentials: "include"
})
.then(res => {
    if (res.status === 401) {
        window.location.href = "login.html";
        return;
    }
    return res.json();
})
.then(data => {
    if (!data) return;

    const list = document.getElementById("candidates");

    data.forEach(c => {
        const li = document.createElement("li");
        li.className = "list-group-item";

        li.innerHTML = `
            <input type="radio" name="candidate" value="${c.id}"
                   onclick="selectedCandidate=${c.id}">
            ${c.name}
        `;

        list.appendChild(li);
    });
})
.catch(err => {
    console.error("Error cargando candidatos:", err);
    alert("Error cargando candidatos");
});

// ðŸ”¹ Enviar voto (usando sesiÃ³n por cookie)
function submitVote() {

    if (!selectedCandidate) {
        alert("SeleccionÃ¡ un candidato");
        return;
    }

    fetch("http://localhost:5000/vote", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        credentials: "include",
        body: JSON.stringify({
            election_id: electionId,
            candidate_id: selectedCandidate
        })
    })
    .then(res => {
        if (res.status === 401) {
            window.location.href = "login.html";
            return;
        }
        return res.json();
    })
    .then(data => {
        if (!data) return;

        if (data.error) {
            alert(data.error);
        } else {
            alert("Voto registrado correctamente");
            window.location.href = "index.html";
        }
    })
    .catch(err => {
        console.error("Error al votar:", err);
        alert("Error enviando voto");
    });
}

</script>

</body>
</html>
